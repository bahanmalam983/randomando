<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Randomando — On-Chain Random Number Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg-deep: #0c0b12;
      --bg-panel: #16141f;
      --bg-elevated: #1e1b2a;
      --border: #2d2840;
      --text: #e8e4f0;
      --text-muted: #8b849a;
      --accent: #7c5cff;
      --accent-dim: #5a42c2;
      --success: #4ade80;
      --warn: #fbbf24;
      --err: #f87171;
      --radius: 12px;
      --radius-sm: 8px;
      --font-mono: "JetBrains Mono", "Fira Code", "Consolas", monospace;
      --font-sans: "DM Sans", "Inter", system-ui, sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-sans);
      background: var(--bg-deep);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
      background-image:
        radial-gradient(ellipse 80% 50% at 50% -20%, rgba(124, 92, 255, 0.15), transparent),
        radial-gradient(ellipse 60% 40% at 100% 50%, rgba(92, 124, 255, 0.06), transparent);
    }

    .app-shell {
      max-width: 720px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text);
    }
    .logo span { color: var(--accent); }

    .wallet-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .network-badge {
      font-size: 0.75rem;
      padding: 0.35rem 0.6rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    .btn {
      font-family: var(--font-sans);
      font-size: 0.9rem;
      font-weight: 600;
      padding: 0.6rem 1.2rem;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }
    .btn-primary:hover:not(:disabled) {
      background: var(--accent-dim);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
    }
    .btn-ghost:hover:not(:disabled) {
      background: var(--bg-elevated);
      color: var(--text);
    }

    .card {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 1.25rem;
    }

    .card-title {
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }

    .dice-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 0.75rem;
    }

    .dice-btn {
      padding: 1rem;
      background: var(--bg-elevated);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .dice-btn:hover {
      border-color: var(--accent);
      background: rgba(124, 92, 255, 0.08);
    }
    .dice-btn.selected {
      border-color: var(--accent);
      background: rgba(124, 92, 255, 0.15);
    }

    .custom-range-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .custom-range-row input {
      width: 120px;
      padding: 0.5rem 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 0.95rem;
    }
    .custom-range-row input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .action-row {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.25rem;
      flex-wrap: wrap;
    }

    .result-box {
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 0.5rem;
      background: var(--bg-elevated);
      border: 1px dashed var(--border);
      border-radius: var(--radius-sm);
      padding: 1.5rem;
      margin-top: 1rem;
    }

    .result-value {
      font-size: 3rem;
      font-weight: 800;
      font-family: var(--font-mono);
      color: var(--accent);
      line-height: 1;
    }

    .result-label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .status-msg {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
      min-height: 1.2em;
    }
    .status-msg.success { color: var(--success); }
    .status-msg.error { color: var(--err); }
    .status-msg.warn { color: var(--warn); }

    .history-list {
      list-style: none;
    }

    .history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .history-item:last-child { border-bottom: none; }

    .history-nonce {
      font-family: var(--font-mono);
      color: var(--text-muted);
    }
    .history-bound { color: var(--accent); font-weight: 600; }
    .history-result { color: var(--success); font-family: var(--font-mono); }
    .history-pending { color: var(--warn); }

    .address-display {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      color: var(--text-muted);
      word-break: break-all;
      margin-top: 0.5rem;
    }

    .footer-note {
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .loading { animation: pulse 1s ease-in-out infinite; }

    @keyframes roll-in {
      0% { transform: scale(0.8); opacity: 0; }
      60% { transform: scale(1.05); }
      100% { transform: scale(1); opacity: 1; }
    }
    .result-value.revealed { animation: roll-in 0.4s ease-out; }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .info-cell {
      background: var(--bg-elevated);
      padding: 0.75rem 1rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
    }
    .info-cell .label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; }
    .info-cell .value { font-family: var(--font-mono); font-size: 0.9rem; margin-top: 0.25rem; }

    .how-list { padding-left: 1.25rem; margin-top: 0.75rem; }
    .how-list li { margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem; }

    .preset-row { margin-bottom: 0.5rem; }
    .preset-row button {
      font-size: 0.85rem;
      padding: 0.4rem 0.8rem;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      cursor: pointer;
    }
    .preset-row button:hover { border-color: var(--accent); color: var(--accent); }

    .contract-addr {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      word-break: break-all;
      background: var(--bg-elevated);
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius-sm);
      margin-top: 0.5rem;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <h1 class="logo">Random<span>ando</span></h1>
      <div class="wallet-row">
        <span class="network-badge" id="networkBadge">—</span>
        <button type="button" class="btn btn-primary" id="connectBtn">Connect wallet</button>
        <span class="address-display" id="userAddress"></span>
      </div>
    </header>

    <section class="card">
      <h2 class="card-title">Choose range</h2>
      <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1rem;">
        Pick a dice size or enter a custom upper bound (1 to N, inclusive). Your number will be revealed after a short delay.
      </p>
      <div class="dice-grid">
        <button type="button" class="dice-btn" data-bound="6">D6</button>
        <button type="button" class="dice-btn" data-bound="10">D10</button>
        <button type="button" class="dice-btn" data-bound="12">D12</button>
        <button type="button" class="dice-btn" data-bound="20">D20</button>
        <button type="button" class="dice-btn" data-bound="100">D100</button>
        <button type="button" class="dice-btn" data-bound="1000">1–1000</button>
      </div>
      <div class="custom-range-row">
        <label for="customBound">Custom max:</label>
        <input type="number" id="customBound" min="2" max="999983" placeholder="e.g. 42" />
      </div>
      <div style="margin-top: 1rem;">
        <div class="card-title" style="margin-bottom: 0.5rem;">Quick presets</div>
        <div class="preset-row">
          <button type="button" data-preset="2">Coin flip (2)</button>
          <button type="button" data-preset="7">Weekday (7)</button>
          <button type="button" data-preset="52">Card (52)</button>
          <button type="button" data-preset="365">Day of year (365)</button>
          <button type="button" data-preset="10000">1–10000</button>
        </div>
      </div>
      <div class="action-row">
        <button type="button" class="btn btn-primary" id="requestBtn" disabled>Request random</button>
        <button type="button" class="btn btn-ghost" id="revealBtn" disabled>Reveal last</button>
      </div>
      <div class="status-msg" id="statusMsg"></div>
      <div class="result-box">
        <span class="result-value" id="resultValue">—</span>
        <span class="result-label" id="resultLabel">Request and reveal to see result</span>
      </div>
    </section>

    <section class="card">
      <h2 class="card-title">Your recent requests</h2>
      <ul class="history-list" id="historyList">
        <li class="history-item" style="color: var(--text-muted);">Connect and request to see history.</li>
      </ul>
    </section>

    <section class="card">
      <h2 class="card-title">How it works</h2>
      <ol class="how-list">
        <li>Connect your wallet and ensure you are on the same network as the deployed Randomando contract.</li>
        <li>Choose a range: dice (D6, D20, etc.) or a custom maximum. The result will be an integer from 1 to that bound (inclusive).</li>
        <li>Click &quot;Request random&quot; to submit a transaction. The contract stores your request and assigns a nonce.</li>
        <li>Wait for the required number of blocks (block delay) so that the future block hash is unknown when you requested.</li>
        <li>Click &quot;Reveal last&quot; to compute and store the result on-chain. The value is derived from the block hash and your request data.</li>
      </ol>
      <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 1rem;">
        Entropy is block-bound and deterministic once the block is mined. Do not use for high-value or security-critical randomness.
      </p>
    </section>

    <section class="card">
      <h2 class="card-title">Contract info</h2>
      <div class="info-grid">
        <div class="info-cell">
          <div class="label">Network</div>
          <div class="value" id="infoChain">—</div>
        </div>
        <div class="info-cell">
          <div class="label">Block delay</div>
          <div class="value" id="infoBlockDelay">—</div>
        </div>
      </div>
      <div style="margin-top: 1rem;">
        <div class="label" style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Contract address</div>
        <div class="contract-addr" id="contractAddr">0xC4d5E6F7A8B9c0D1e2F3a4B5c6D7e8F9a0B1C2d3</div>
      </div>
    </section>

    <p class="footer-note">
      Randomando uses block-bound entropy. For games and non-critical use only. Deploy your own contract and point this UI to its address.
    </p>
  </div>

  <script>
    (function () {
      const CONTRACT_ADDRESS = "0xC4d5E6F7A8B9c0D1e2F3a4B5c6D7e8F9a0B1C2d3";
      const ABI = [
        "function requestRand(uint256 bound_) external returns (uint256 nonce)",
        "function revealRand(address requester_, uint256 nonce_, uint256 bound_) external returns (uint256 result)",
        "function computeNext(address requester_, uint256 nonce_, uint256 bound_) view returns (uint256 result)",
        "function callerNonce(address) view returns (uint256)",
        "function blockDelay() view returns (uint256)",
        "function maxRange() view returns (uint256)",
        "event RandRequested(address indexed requester, uint256 indexed nonce, uint256 bound, uint256 atBlock)",
        "event RandRevealed(address indexed requester, uint256 indexed nonce, uint256 result, bytes32 commitment)"
      ];

      let provider = null;
      let signer = null;
      let contract = null;
      let selectedBound = 6;
      let lastRequest = { nonce: null, bound: null };
      let history = [];

      const connectBtn = document.getElementById("connectBtn");
      const networkBadge = document.getElementById("networkBadge");
      const userAddress = document.getElementById("userAddress");
      const customBound = document.getElementById("customBound");
      const requestBtn = document.getElementById("requestBtn");
      const revealBtn = document.getElementById("revealBtn");
      const statusMsg = document.getElementById("statusMsg");
      const resultValue = document.getElementById("resultValue");
      const resultLabel = document.getElementById("resultLabel");
      const historyList = document.getElementById("historyList");

      function setStatus(msg, type) {
        statusMsg.textContent = msg || "";
        statusMsg.className = "status-msg" + (type ? " " + type : "");
      }

      function setResult(value, label) {
        resultValue.textContent = value;
        resultLabel.textContent = label || "";
        if (value !== "—") resultValue.classList.add("revealed");
      }

      function getBound() {
        const custom = parseInt(customBound.value, 10);
        if (!isNaN(custom) && custom >= 2) return Math.min(999983, custom);
        return selectedBound;
      }

      function updateNetworkInfo() {
        if (!provider) return;
        provider.getNetwork().then(function (net) {
          const name = net.name !== "unknown" ? net.name : "Chain " + net.chainId.toString();
          networkBadge.textContent = name;
        }).catch(function () {
          networkBadge.textContent = "—";
        });
      }

      async function connect() {
        if (typeof window.ethereum === "undefined") {
          setStatus("Install MetaMask or another Web3 wallet.", "error");
          return;
        }
        try {
          provider = new ethers.BrowserProvider(window.ethereum);
          const accounts = await provider.send("eth_requestAccounts", []);
          if (!accounts.length) {
            setStatus("No account selected.", "error");
            return;
          }
          signer = await provider.getSigner();
          contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
          userAddress.textContent = "Connected: " + accounts[0].slice(0, 6) + "…" + accounts[0].slice(-4);
          connectBtn.textContent = "Connected";
          connectBtn.disabled = true;
          updateNetworkInfo();
          requestBtn.disabled = false;
          revealBtn.disabled = false;
          await loadHistory();
          await updateContractInfo();
          setStatus("Wallet connected. Choose a range and request a number.", "success");
        } catch (e) {
          setStatus(e.message || "Connection failed.", "error");
        }
      }

      document.querySelectorAll(".dice-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          document.querySelectorAll(".dice-btn").forEach(function (b) { b.classList.remove("selected"); });
          btn.classList.add("selected");
          selectedBound = parseInt(btn.dataset.bound, 10);
          customBound.value = "";
        });
      });

      customBound.addEventListener("input", function () {
        if (customBound.value) {
          document.querySelectorAll(".dice-btn").forEach(function (b) { b.classList.remove("selected"); });
        }
      });

      document.querySelectorAll(".preset-row button").forEach(function (btn) {
        btn.addEventListener("click", function () {
          const n = parseInt(btn.dataset.preset, 10);
          if (!isNaN(n)) {
            customBound.value = n;
            document.querySelectorAll(".dice-btn").forEach(function (b) { b.classList.remove("selected"); });
          }
        });
      });

      requestBtn.addEventListener("click", async function () {
        if (!contract || !signer) return;
        const bound = getBound();
        if (bound < 2) {
          setStatus("Enter a bound of at least 2.", "error");
          return;
        }
        requestBtn.disabled = true;
        setStatus("Requesting on-chain…", "");
        try {
          const tx = await contract.requestRand(bound);
          setStatus("Waiting for confirmation…", "");
          const receipt = await tx.wait();
          const addr = await signer.getAddress();
          const nonce = receipt.logs && receipt.logs.length
            ? (await contract.callerNonce(addr)) - 1
            : 0;
          lastRequest = { nonce, bound };
          history.unshift({ nonce, bound, result: null, pending: true });
          renderHistory();
          setStatus("Request confirmed. Wait a few blocks then click Reveal last.", "success");
          setResult("—", "Reveal when ready");
        } catch (e) {
          setStatus(e.message || "Request failed.", "error");
        }
        requestBtn.disabled = false;
      });

      revealBtn.addEventListener("click", async function () {
        if (!contract || !signer) return;
        const addr = await signer.getAddress();
        const nonce = lastRequest.nonce;
        const bound = lastRequest.bound;
        if (nonce == null) {
          setStatus("Request a number first.", "warn");
          return;
        }
        revealBtn.disabled = true;
        setStatus("Revealing…", "");
        try {
          const tx = await contract.revealRand(addr, nonce, bound);
          await tx.wait();
          const result = await contract.computeNext(addr, nonce, bound);
          setResult(String(Number(result) + 1), "Result (1–" + bound + ")");
          setStatus("Revealed successfully.", "success");
          const idx = history.findIndex(function (h) { return h.nonce === nonce && h.bound === bound; });
          if (idx >= 0) {
            history[idx].result = Number(result) + 1;
            history[idx].pending = false;
          }
          renderHistory();
        } catch (e) {
          setStatus(e.message || "Reveal failed. Try again after a few blocks.", "error");
        }
        revealBtn.disabled = false;
      });

      function renderHistory() {
        if (!history.length) {
          historyList.innerHTML = "<li class=\"history-item\" style=\"color: var(--text-muted);\">No requests yet.</li>";
          return;
        }
        historyList.innerHTML = history.slice(0, 15).map(function (h) {
          const res = h.pending
            ? "<span class=\"history-pending\">Pending</span>"
            : "<span class=\"history-result\">" + h.result + "</span>";
          return "<li class=\"history-item\"><span class=\"history-nonce\">#" + h.nonce + "</span> <span class=\"history-bound\">1–" + h.bound + "</span> → " + res + "</li>";
        }).join("");
      }

      async function loadHistory() {
        if (!contract || !signer) return;
        try {
          const addr = await signer.getAddress();
          const nonceCount = await contract.callerNonce(addr);
          history = [];
          for (let i = 0; i < Math.min(Number(nonceCount), 20); i++) {
            history.push({ nonce: i, bound: null, result: null, pending: true });
          }
          renderHistory();
        } catch (_) {
          renderHistory();
        }
      }

      async function updateContractInfo() {
        if (!provider || !contract) return;
        try {
          const net = await provider.getNetwork();
          document.getElementById("infoChain").textContent = net.name !== "unknown" ? net.name : "Chain " + net.chainId.toString();
          const delay = await contract.blockDelay();
          document.getElementById("infoBlockDelay").textContent = delay.toString() + " blocks";
        } catch (_) {
          document.getElementById("infoChain").textContent = "—";
          document.getElementById("infoBlockDelay").textContent = "—";
        }
        document.getElementById("contractAddr").textContent = CONTRACT_ADDRESS;
      }

      connectBtn.addEventListener("click", connect);

      if (window.ethereum) {
        window.ethereum.on("chainChanged", function () {
          updateNetworkInfo();
          if (provider) contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
        });
        window.ethereum.on("accountsChanged", function (accounts) {
          if (!accounts.length) {
            connectBtn.textContent = "Connect wallet";
            connectBtn.disabled = false;
            userAddress.textContent = "";
            requestBtn.disabled = true;
            revealBtn.disabled = true;
            history = [];
            renderHistory();
          }
        });
      }
    })();
  </script>
</body>
</html>
